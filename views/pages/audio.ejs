<!DOCTYPE html>
<html>

<head>
    <title>Les particules de la creation</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <div class="center">
            <div style="margin-top: 30vh;">
                <h5 class="textIntro">
                    <p>Audio Analyzer</p>
                </h5>
            </div>
            <label for="file-upload" class="custom-file-upload">
                Your file
            </label>
            <input id="file-upload" type="file" />

            <button class="start" onclick="start()" id="Start" disabled>Start</button>
        </div>
    </div>


    <script src="three.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script type="text/javascript">
        var camera, scene, renderer;
        var geometry, material, mesh;
        var particleSystem;
        var data;
        var analyser;
        var arraydata;
        var path;
        var start;
        var sound;
        var isStop = false;
        var blueRotate = "plus";
        var orangeRotate = "minus";
        var pinkRotate = "plus";
        var newaction = false;

        $("#file-upload").change(function () {
            console.log(this.files)


            // generate a new FileReader object
            var reader = new FileReader();

            // inject an image with the src url
            reader.onload = function (event) {
                path = event.target.result;
                $('.start').prop('disabled', false);
            }

            reader.readAsDataURL(this.files[0]);

        });

        function start() {
            $(".container").fadeOut("slow", function () {
                $('.container').css('display', 'none');

                $("body").click(function () {
                    newaction = true;
                    if (isStop == false) {
                        isStop = true;
                    }
                    else {
                        isStop = false;
                    }
                });
            });

            $('body').keyup(function (e) {
                if (e.keyCode == 32) {
                    newaction = true;
                    if (isStop == false) {
                        isStop = true;
                    }
                    else {
                        isStop = false;
                    }
                }
            });



            start = true;
            init();
            animate();


        }

        function init() {

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 120);
            camera.position.z = 0;

            scene = new THREE.Scene();


            var particleCount1 = 30000,
                particles1 = new THREE.Geometry(),
                pMaterial1 = new THREE.PointsMaterial({
                    color: 0xFFFFFF,
                    size: 4,
                    map: new THREE.TextureLoader().load("flashBlue.png"),
                    transparent: true,
                    depthWrite: false,
                    blending: THREE.AdditiveBlending,
                });
            // now create the individual particles
            for (var p = 0; p < particleCount1; p++) {

                // create a particle with random
                // position values, -250 -> 250
                var pX = Math.random() * 500 - 250,
                    pY = Math.random() * 500 - 250,
                    pZ = Math.random() * 500 - 250,
                    particle1 =
                        new THREE.Vector3(pX, pY, pZ);

                // add it to the geometry
                particles1.vertices.push(particle1);
            }

            particleSystem1 = new THREE.Points(
                particles1,
                pMaterial1);

            particleSystem1.sortParticles = true;

            scene.add(particleSystem1);


            var particleCount2 = 25000,
                particles2 = new THREE.Geometry(),
                pMaterial2 = new THREE.PointsMaterial({
                    color: 0xFFFFFF,
                    size: 4,
                    map: new THREE.TextureLoader().load('flashOrange.png'),
                    transparent: true,
                    depthWrite: false,
                    blending: THREE.AdditiveBlending,
                });
            // now create the individual particles
            for (var p = 0; p < particleCount2; p++) {

                // create a particle with random
                // position values, -250 -> 250
                var pX = Math.random() * 500 - 250,
                    pY = Math.random() * 500 - 250,
                    pZ = Math.random() * 500 - 250,
                    particle2 =
                        new THREE.Vector3(pX, pY, pZ);

                // add it to the geometry
                particles2.vertices.push(particle2);
            }

            particleSystem2 = new THREE.Points(
                particles2,
                pMaterial2);

            particleSystem2.sortParticles = true;

            scene.add(particleSystem2);

            var particleCount3 = 15000,
                particles3 = new THREE.Geometry(),
                pMaterial3 = new THREE.PointsMaterial({
                    color: 0xFFFFFF,
                    size: 4,
                    map: new THREE.TextureLoader().load('flashPink.png'),
                    transparent: true,
                    depthWrite: false,
                    blending: THREE.AdditiveBlending,
                });
            // now create the individual particles
            for (var p = 0; p < particleCount3; p++) {

                // create a particle with random
                // position values, -250 -> 250
                var pX = Math.random() * 500 - 250,
                    pY = Math.random() * 500 - 250,
                    pZ = Math.random() * 500 - 250,
                    particle3 =
                        new THREE.Vector3(pX, pY, pZ);

                // add it to the geometry
                particles3.vertices.push(particle3);
            }

            particleSystem3 = new THREE.Points(
                particles3,
                pMaterial3);

            particleSystem3.sortParticles = true;

            scene.add(particleSystem3);

            var light = new THREE.PointLight(0xff0000, 100, 100);
            light.position.set(0, 0, 0);
            scene.add(light);

            // create an AudioListener and add it to the camera
            var listener = new THREE.AudioListener();
            camera.add(listener);

            // create an Audio source
            sound = new THREE.Audio(listener);

            // load a sound and set it as the Audio object's buffer
            var audioLoader = new THREE.AudioLoader();
            audioLoader.load(path, function (buffer) {
                sound.setBuffer(buffer);
                sound.setLoop(false);
                sound.setVolume(0.5);
                sound.play();
            });

            // create an AudioAnalyser, passing in the sound and desired fftSize
            analyser = new THREE.AudioAnalyser(sound, 32);

            // get the average frequency of the sound
            data = analyser.getAverageFrequency();

            renderer = new THREE.WebGLRenderer({ alpha: true, premultipliedAlpha: false });
            renderer.setClearColor(0x000000, 0);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

        }

        function animate() {


            // add some rotation to the system

            arraydata = analyser.getFrequencyData();

            // Blue particles rotation & sizing
            if (blueRotate == "plus") {
                particleSystem1.rotation.y += arraydata[1] / 15000;
                particleSystem1.rotation.x -= arraydata[1] / 20000;
            }

            if (blueRotate == "minus") {
                particleSystem1.rotation.y -= arraydata[1] / 15000;
                particleSystem1.rotation.x += arraydata[1] / 20000;
            }

            if (arraydata[1] >= 235 && particleSystem1['material'].size <= 8) {
                particleSystem1['material'].size += 1;
                if (particleSystem1['material'].size == 8)
                    blueRotate = "minus"
            }
            else {
                if (particleSystem1['material'].size > 4)
                    particleSystem1['material'].size -= 1;
                if (particleSystem1['material'].size == 4)
                    blueRotate = "plus"
            }

            // Orange particles rotation & sizing
            if (orangeRotate == "plus") {
                particleSystem2.rotation.y += arraydata[4] / 10000;
            }

            if (orangeRotate == "minus") {
                particleSystem2.rotation.y -= arraydata[4] / 10000;
            }

            if (arraydata[4] >= 180 && particleSystem2['material'].size <= 8) {

                particleSystem2['material'].size += 1;
                if (particleSystem2['material'].size == 8)
                    orangeRotate = "plus"
            }
            else {
                if (particleSystem2['material'].size > 4)
                    particleSystem2['material'].size -= 1;
                if (particleSystem2['material'].size == 4)
                    orangeRotate = "minus"
            }

            // Pink particles rotation & sizing
            if (pinkRotate == "plus") {
                particleSystem3.rotation.y += arraydata[6] / 10000;
            }

            if (pinkRotate == "minus") {
                particleSystem3.rotation.y -= arraydata[6] / 10000;
            }

            if (arraydata[6] >= 130 && particleSystem3['material'].size <= 8) {
                particleSystem3['material'].size += 1;
                if (particleSystem3['material'].size == 8)
                    pinkRotate = "minus"
            }
            else {
                if (particleSystem3['material'].size > 4)
                    particleSystem3['material'].size -= 1;
                if (particleSystem3['material'].size == 4)
                    pinkRotate = "plus"
            }



            if (newaction) {
                if (isStop == true) {
                    sound.pause();
                }
                else {
                    sound.play();
                }
                newaction = false;
            }

            // draw
            renderer.render(scene, camera);

            // set up the next call
            requestAnimationFrame(animate);


        }

        window.addEventListener('resize', onWindowResize, false);

        function onWindowResize() {

            if (start == true) {

                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();

                renderer.setSize(window.innerWidth, window.innerHeight);
            }

        }
    </script>

</body>

</html>